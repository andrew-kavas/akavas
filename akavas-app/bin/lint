#!/bin/sh -e

maxTscErrors=0
verbose=0
filtered_args=""

for arg in "$@"; do
  if [ "$arg" = "--verbose" ]; then
    verbose=1
  else
    filtered_args="$filtered_args $arg"
  fi
done

node_modules/.bin/eslint --color --quiet $filtered_args src &
eslintPid=$!

{
  tscOutput=$(node node_modules/typescript/lib/tsc.js || true)
  tscErrors=$(echo "$tscOutput" | (fgrep '): error TS' || true) | wc -l | tr -d ' ')

  if [ "$verbose" -eq 1 ]; then
    echo "$tscOutput"
  fi

  if [ $tscErrors -gt $maxTscErrors ]; then
    echo "The $tscErrors TSC errors exceeds the limit of $maxTscErrors"
    exit 1
  else
    echo "The $tscErrors TSC errors is within the limit of $maxTscErrors"
  fi
}

wait $eslintPid
